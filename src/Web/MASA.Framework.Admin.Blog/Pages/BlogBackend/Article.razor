@page "/blog-admin/article"
@using MASA.Framework.Admin.Blog.Pages.BlogBackend.Components
@inherits ProCompontentBase

<PPageHeader Title="搜索" ShowFiltersByDefault OnSearch="() => FetchList()">
    <Filters Context="filter">
        <MRow Dense>
            <MCol Cols="12" Sm="6" Md="4">
                <DefaultTextField Label="标题"
                                  @bind-Value="_options.Title"
                                  OnKeyDown="filter.onEnter"
                                  OnClearClick="filter.onSearch">
                </DefaultTextField>
            </MCol>
            <MCol Cols="12" Sm="6" Md="4">
                <DefaultAutoComplete Label="分类"
                                     Items="BlogTypes"
                                     ItemText="item => item.Name"
                                     ItemValue="item => item.Id"
                                     @bind-Value="_options.TypeId"
                                     TItem="BlogTypeCondensedViewModel"
                                     TValue="Guid?"
                                     TItemValue="Guid"
                                     OnSelectedItemUpdate="filter.onSearch"
                                     OnClearClick="filter.onSearch">
                </DefaultAutoComplete>
            </MCol>
            <MCol Cols="12" Sm="6" Md="4">
                <DefaultSelect Label="状态"
                               Items="Enum<StateTypes>.GetEnumObjectList<StateTypes>()"
                               ItemText="item => item.Name"
                               ItemValue="item => item.Value"
                               @bind-Value="_options.State"
                               TItem="EnumObject<StateTypes>"
                               TValue="StateTypes?"
                               TItemValue="StateTypes"
                               OnSelectedItemUpdate="filter.onSearch"
                               OnClearClick="filter.onSearch">
                </DefaultSelect>
            </MCol>
            <MCol Cols="12" Sm="6" Md="4">
                <DefaultDateTimePicker Label="发布开始时间"
                                       @bind-Value="_options.ReleaseStartTime"
                                       OnOk="filter.onSearch"
                                       OnClearClick="filter.onSearch">
                </DefaultDateTimePicker>
            </MCol>
            <MCol Cols="12" Sm="6" Md="4">
                <DefaultDateTimePicker Label="发布结束时间"
                                       @bind-Value="_options.ReleaseEndTime"
                                       OnOk="filter.onSearch"
                                       OnClearClick="filter.onSearch">
                </DefaultDateTimePicker>
            </MCol>
            <MCol Cols="12" Sm="6" Md="4">
                <DefaultTextField Label="作者"
                                  @bind-Value="_options.Author"
                                  OnKeyDown="filter.onEnter"
                                  OnClearClick="filter.onSearch">
                </DefaultTextField>
            </MCol>
        </MRow>
    </Filters>
</PPageHeader>

<DefaultDataTable Headers="_headers"
                  Items="_tableData"
                  Loading="_loading"
                  OnOptionsUpdate="HandleOnOptionsUpdate"
                  Page="_options.PageIndex"
                  ItemsPerPage="_options.PageSize"
                  ServerItemsLength="_totalCount"
                  TItem="BlogInfoListViewModel">
    <ItemColContent>
        @if (context.Header.Value == "actions")
        {
            <Actions>
                <Action Color="primary" 
                        Icon="mdi-eye-outline"
                        Label="查看"
                        OnClick="() => HrefDetailPage(context.Item.Id)">
                </Action>
                <Action Visible="@(context.Item.State == StateTypes.Reviewed)"
                        Color="error" 
                        Icon="mdi-book-off-outline"
                        Label="下架"
                        OnClick="() => ShowWithdrawModal(context.Item)">
                </Action>
                <Action Visible="@(context.Item.State == StateTypes.ToBeReviewed)"
                        Color="primary" 
                        Icon="mdi-book-arrow-down-outline"
                        Label="审核" 
                        OnClick="() => AuditArticleAsync(context.Item)">
                </Action>
            </Actions>
        }
        else if (context.Header.Value == nameof(BlogInfoListViewModel.State))
        {
            <MTooltip Disabled="@(context.Item.State != StateTypes.OffTheShelf)" Top>
                <ActivatorContent Context="activatorContext">
                    <ColorChip Colors="@(new[] { "", "grey", "red", "green", "orange" })"
                               Value="context.Item.State"
                               @attributes="@activatorContext.Attrs">
                    </ColorChip>
                </ActivatorContent>
                <ChildContent>
                    @context.Item.WithdrawReason
                </ChildContent>
            </MTooltip>
        }
        else
        {
            <DefaultGenericColumnRender Value="@context.Value" ChippedEnum></DefaultGenericColumnRender>
        }
    </ItemColContent>
</DefaultDataTable>

<WithdrawModal Title="@($"下架文章（{CurrentModel?.Title}）")"
               Visible="_withdrawModalVisible"
               Width="800"
               OnCancel="() => _withdrawModalVisible = false"
               OnOk="OnWithdraw"/>